### 1\. 新的 UI 交互逻辑： 1+3 模式

主界面不再只是一个“预设下拉框”，而是分为两层：

1.  **顶层：快捷场景宏 (Macro Presets)** —— 也就是之前的“极速/标准/精修”，点击它们会自动改变下面三个模块的选项。
2.  **底层：三个独立模块卡片 (Component Modules)** —— 用户可以手动修改其中任何一个，修改后顶层宏变为“自定义”。

#### 界面可视化构想（注意只是展示前端界面，具体项以下面预设为准）

```text
[ 场景快捷键:  ⚡️极速会议  |  ⚖️标准创作(推荐)  |  🎬影视精修  ] 

---------------------------------------------------------------

1. 🔊 前处理 (Demucs)       2. 📝 转录核心 (ASR)       3. 🧠 增强 (LLM)
[ 🟢 直通 (不处理)    ]    [ 🟡 极速 (SenseVoice) ]   [ 🔴 关闭           ]
[ ⚪️ 智能分诊 (Auto) ]    [ 🟢 智能补刀 (SV+Whs) ]   [ ⚪️ 仅校对 (稀疏)   ]
[ ⚪️ 极致分离 (Pro)  ]    [ ⚪️ 双流精校 (Hybrid) ]   [ ⚪️ 全局精修+翻译   ]

---------------------------------------------------------------
(底部仍然保留 "⚙️ 高级参数" 用于调整阈值等微操)
```

-----

### 2\. 三个维度的具体预设设计

我们需要为每个模块定义 3-4 个标准档位。

#### 模块一：人声分离

*控制 Demucs 的行为*

1.  **禁止分离**:
      * 行为：不进行人声分离。
      * 适用：纯人声录音、无背景音乐视频、为了速度牺牲噪点。
2.  **智能分诊** (*默认*):
      * 行为：完全依赖频谱分诊的建议
      * 适用：大多数短视频、Vlog。
3.  **极致分离**:
      * 行为：强制使用 `mdx_extra`分离。
      * 适用：电影、MV、背景音乐极大的素材。

#### 模块二：转录

*控制 ASR 引擎组合与策略*

1.  **极速转录**(默认):
      * 行为：SenseVoice (Int8) 单引擎。
      * 适用：只需要看懂内容，不在意少量错别字。
2.  **智能补刀** :
      * 行为：SenseVoice 主转录 + Whisper (Medium) 对 `<60%` 置信度片段重跑。
      * 适用：追求性价比，平衡速度与准确率。
3.  **双流精校**:
      * 行为：SenseVoice 抓时间轴 + Whisper Medium全文填词 (并行或串行)。
      * 适用：生产级字幕，压制组。

#### 模块三：增强

*控制 LLM 的介入程度*

1.  **关闭**（默认）:
      * 行为：原生 ASR 输出。
2.  **稀疏校对** :
      * 行为：仅提取低置信度句子 + 上下文发给 LLM 修正错别字。
      * 适用：修正同音词，节省 Token。
3.  **全局校对**:
      * 行为：全文发送 LLM校对。
4.  **翻译**:
      * 行为：全文发送 LLM，执行“校对+翻译”。

-----


### 4\. 解决“硬件限制”的逻辑 (Guardrails)

既然拆分了三个维度，硬件检测的熔断机制也变得更灵活：

  * **UI 层的互斥 (Frontend Logic)**:

      * 如果 **检测不到 GPU**:
         模块一的极致分离不可选，智能分诊即使检测到重度阈值也退回到使用htdemucs
         模块二的双流精校、智能补刀不可选

  * **后端层的适配 (Backend Factory)**:
    根据上面设计


-----
高级设置项：

### 分组一：🔊 预处理与音频 (Preprocessing)

**核心职责**：决定送入转录引擎的音频质量。

| 项名称 (Key) | 显示名称 (Label) | 类型 | 选项范围 / 默认值 | 依赖逻辑与互斥 (Logic & Dependencies) |
| :--- | :--- | :--- | :--- | :--- |
| `demucs_strategy` | **人声分离策略** | **单选** | • **关闭 (Off)**<br>• **智能分诊 (Auto)** *(默认)*<br>• **强制开启 (Force On)** | 决定下方 Demucs 相关项是否可用。 |
| `demucs_model` | **分离模型选择** | **单选** | • **htdemucs** <br>• **htdemucs\_ft** <br/>• mdx_q<br/>• mdx_extra | 🔒 **锁死**: 当 `人声分离策略` = `关闭` 时不可用。<br>⚠️ **警告**: mdx开头的两个模型效果更好但速度较慢，长视频慎用 |
| `demucs_shifts` | **分离预测次数** | **数值** | 范围: 1-5 (默认: 1) | 🔒 **锁死**: 当 `人声分离策略` = `关闭` 时不可用。<br>ℹ️ 数值越高分离效果越好，但速度成倍下降。 |
| `spectrum_threshold` | **分诊灵敏度** | **滑块** | 0.0 - 1.0 (默认: 去分诊代码中找) | 🔒 **锁死**: 仅当 `人声分离策略` = `智能分诊` 时可用。<br>ℹ️ 值越低，越容易触发分离（更敏感）。 |
| `vad_filter` | **VAD 静音过滤** | **开关** | 开启/关闭 (默认: 开启) | 开启后会自动切除大段静音，建议常开。 |

-----

### 分组二：📝 转录核心 (Transcription)

**核心职责**：控制 ASR 引擎的组合方式和介入程度。

| 项名称 (Key) | 显示名称 (Label) | 类型 | 选项范围 / 默认值 | 依赖逻辑与互斥 (Logic & Dependencies) |
| :--- | :--- | :--- | :--- | :--- |
| `transcription_profile` | **转录流水线模式** | **单选** | • **仅 SenseVoice**<br>• **SV + Whisper 补刀**<br>• **SV + Whisper 双流** | 决定下方 Whisper 相关项是否可用。 |
| `sensevoice_device` | **主引擎运行设备** | **单选** | • Auto (优先GPU)<br>• CPU 强制 | 一般不建议改动，除非显存极度紧张。 |
| `whisper_model` | **辅助/补刀模型** | **单选** | • tiny<br>• small<br>• medium *(默认)*<br>• large-v3 | 🔒 **锁死**: 当 `转录流水线模式` = `仅 SenseVoice` 时不可用。<br>🔒 **强制**: 若无 GPU，禁用。 |
| `patching_threshold` | **补刀触发阈值** | **滑块** | 0.0 - 1.0 (默认: 0.60) | 🔒 **锁死**: 仅当 `转录流水线模式` = `补刀模式` 时可用。<br>ℹ️ 低于此置信度的句子会送给 Whisper 重跑。 |
|                         |                    |          |                                                              |                                                              |

-----

### 分组三：🧠 增强与润色 (Refinement / LLM)

**核心职责**：控制大语言模型的后期处理。

| 项名称 (Key) | 显示名称 (Label) | 类型 | 选项范围 / 默认值 | 依赖逻辑与互斥 (Logic & Dependencies) |
| :--- | :--- | :--- | :--- | :--- |
| `llm_task` | **LLM 任务目标** | **单选** | • **关闭**<br>• **仅校对** (修正错字)<br>• **翻译** (含校对) | 决定下方 LLM 相关项是否可用。 |
| `llm_scope` | **介入范围** | **单选** | • **稀疏 (Sparse)** *(默认)*<br>• **全局 (Global)** | 🔒 **锁死**: 当 `LLM 任务目标` = `关闭` 时不可用。<br>⚠️ **互斥**: 若选 `翻译`，建议强制为 `全局`（否则中英混杂）。 |
| `sparse_threshold` | **稀疏校对阈值** | **滑块** | 0.0 - 1.0 (默认: 0.70) | 🔒 **锁死**: 仅当 `介入范围` = `稀疏` 时可用。<br>ℹ️ 只有置信度低于此值的句子会被送去校对。 |
| `target_language` | **目标语言** | **单选** | • 中文<br>• English<br>• Japanese... | 🔒 **锁死**: 仅当 `LLM 任务目标` = `翻译` 时可用。 |
| `llm_provider` | **模型提供商** | **单选** | • OpenAI Compatible<br>• Local (Ollama) | 选择后端接口类型。 |
| `llm_model_name` | **模型名称** | **输入** | 例: `gpt-4o`, `qwen2.5` | 必填项。 |

-----

### 分组四：⚙️ 计算与系统 (Compute & System)

**核心职责**：资源调度与硬件保护。

| 项名称 (Key) | 显示名称 (Label) | 类型 | 选项范围 / 默认值 | 依赖逻辑与互斥 (Logic & Dependencies) |
| :--- | :--- | :--- | :--- | :--- |
| `concurrency_strategy` | **并发调度策略** | **单选** | • **自动 (Auto VRAM)** *(默认)*<br>• **并行 (Parallel)**<br>• **串行 (Serial)** | • **自动**: 根据显存余量决定。<br>• **并行**: 速度最快，Demucs/ASR/LLM 可能同时跑。<br>• **串行**: 节省显存，一步一步来。 |
| `gpu_id` | **GPU 选择** | **多选** | [GPU 0: RTX 4090], [GPU 1...] | 若多卡系统，允许指定使用哪张卡。 |
| `output_format` | **输出格式** | **多选** | ☑️ SRT (默认)<br>☐ VTT<br>☐ TXT<br>☐ JSON (Debug) | 生成结果的文件类型。 |
| `temp_file_policy` | **临时文件策略** | **单选** | • 任务完成后删除<br>• 保留 (用于Debug) | 如果想查看 Demucs 分离出的纯人声 wav，选保留。 |

-----

### 前端 UI 实现建议 (Implementation Note)

1.  **分组展示**：不要把这 20 个选项一股脑列出来。使用 **折叠面板 (Accordion)** 或 **Tab 页** (Audio / ASR / LLM / System)。
2.  **视觉反馈**：
      * **依赖禁用**: 当 `demucs_strategy` 选 "Off" 时，`model` 和 `shifts` 应该变为灰色 (Opacity 0.5) 且不可点击。
      * **显存警告**: 如果用户在只有 4GB 显存的机器上强行开启 `htdemucs_ft` + `Whisper Large` + `Parallel`，UI 应该在底部弹出橙色警告条：“当前配置可能导致显存溢出 (OOM)”。
3.  **预设联动**:
      * 当用户在“主界面”选择了 **[⚡️ 极速预览]**，进入高级设置时，应看到 `demucs_strategy` 为 "Off"，`transcription_profile` 为 "SenseVoice Only"。
      * 此时如果用户手动修改了任何一项，主界面的预设名称应变为 **[ 自定义 ]**。

### 前后端字段对照

| 分组       | 字段 (Key)              | 后端类型  | 前端类型     | 默认值                 |
| :--------- | :---------------------- | :-------- | :----------- | :--------------------- |
| **预处理** | `demucs_strategy`       | str       | select       | `"auto"`               |
|            | `demucs_model`          | str       | select       | `"htdemucs"`           |
|            | `demucs_shifts`         | int       | slider (1-5) | `1`                    |
|            | `spectrum_threshold`    | float     | slider (0-1) | `0.35`                 |
|            | `vad_filter`            | bool      | toggle       | `True`                 |
| **转录**   | `transcription_profile` | str       | select       | `"sensevoice_only"`    |
|            | `sensevoice_device`     | str       | select       | `"auto"`               |
|            | `whisper_model`         | str       | select       | `"medium"`             |
|            | `patching_threshold`    | float     | slider (0-1) | `0.60`                 |
| **增强**   | `llm_task`              | str       | select       | `"off"`                |
|            | `llm_scope`             | str       | select       | `"sparse"`             |
|            | `sparse_threshold`      | float     | slider (0-1) | `0.70`                 |
|            | `target_language`       | str       | select       | `"zh"`                 |
|            | `llm_provider`          | str       | select       | `"openai_compatible"`  |
|            | `llm_model_name`        | str       | input        | `"gpt-4o-mini"`        |
| **计算**   | `concurrency_strategy`  | str       | select       | `"auto"`               |
|            | `gpu_id`                | int       | input        | `0`                    |
|            | `output_formats`        | List[str] | -            | `["srt"]`              |
|            | `temp_file_policy`      | str       | select       | `"delete_on_complete"` |
