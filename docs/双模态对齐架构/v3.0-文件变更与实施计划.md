# Video-to-SRT v3.0 - 文件变更清单与分阶段实施计划

本文档详细列出所有需要修改/新增的文件，以及分阶段的实施计划。

---

## 13. 文件变更清单

### 13.1 新增文件

#### 核心流水线

```
backend/app/pipelines/
├── __init__.py                          [新增]
├── base_pipeline.py                     [新增] 流水线基类
├── dual_alignment_pipeline.py           [新增] 双流对齐流水线（核心）
└── audio_processing_pipeline.py         [新增] 音频前处理流水线
```

#### 任务管理
```
backend/app/services/job/
├── __init__.py                          [新增]
├── job_manager.py                       [新增] 任务管理器（从transcription_service拆分）
├── checkpoint_manager.py                [新增] 断点续传管理（从transcription_service拆分）
└── job_state.py                         [新增] 任务状态定义
```

#### 推理执行器
```
backend/app/services/inference/
├── __init__.py                          [新增]
├── sensevoice_executor.py               [新增] SenseVoice执行器（重构自sensevoice_onnx_service）
└── whisper_executor.py                  [新增] Whisper执行器（重构自whisper_service）
```

#### 对齐服务
```
backend/app/services/alignment/
├── __init__.py                          [新增]
├── alignment_service.py                 [新增] 锚点对齐算法（核心）
└── pseudo_alignment.py                  [保留] 伪对齐算法
```

#### 音频处理
```
backend/app/services/audio/
├── __init__.py                          [新增]
├── chunk_engine.py                      [新增] 音频切分引擎
├── demucs_service.py                    [保留] 人声分离服务
└── vad_service.py                       [新增] VAD服务封装
```

#### SSE增强
```
backend/app/services/streaming/
├── __init__.py                          [新增]
├── sse_publisher.py                     [新增] 增强版SSE发布器（重构自streaming_subtitle）
└── streaming_subtitle.py                [保留] 字幕流服务
```

#### 硬件监测
```
backend/app/services/monitoring/
├── __init__.py                          [新增]
├── hardware_monitor.py                  [新增] 实时硬件监测
├── resource_tracker.py                  [新增] 资源使用追踪
└── model_monitor.py                     [新增] 模型性能监控
```

#### LLM服务
```
backend/app/services/llm/
├── __init__.py                          [新增]
├── llm_service.py                       [新增] LLM服务接口
├── proofreader.py                       [新增] 校对服务
└── translator.py                        [新增] 翻译服务
```

#### 核心模块
```
backend/app/core/
├── config.py                            [修改] 新增LLM、日志、监控配置
├── logging.py                           [重构] 增强日志管理
├── thresholds.py                        [保留] 阈值配置
├── resource_manager.py                  [新增] 显存/模型生命周期管理
└── model_config.py                      [新增] 统一模型配置
```

#### 数据模型
```
backend/app/models/
├── job_models.py                        [修改] 任务模型
├── preset_models.py                     [新增] 预设模型
├── confidence_models.py                 [新增] 置信度模型（WordTimestamp, AlignedSubtitle）
└── hardware_models.py                   [保留] 硬件信息模型
```

#### API路由
```
backend/app/api/routes/
├── transcription_routes.py              [修改] 新增历史事件API
├── preset_routes.py                     [新增] 预设API
└── monitor_routes.py                    [新增] 监控API
```

#### 前端组件
```
frontend/src/components/editor/
├── PresetSelector.vue                   [修改] 新增硬件提示
├── SubtitleItem.vue                     [新增] 置信度可视化
├── SSEStatusIndicator.vue               [新增] SSE连接状态指示器
└── LLMSettings.vue                      [新增] LLM功能开关
```

#### 前端服务
```
frontend/src/services/
├── sseChannelManager.js                 [修改] 增强断线重连
└── api/
    ├── system.js                        [新增] 系统监控API
    └── preset.js                        [新增] 预设API
```

#### 前端模型
```
frontend/src/models/
└── subtitle.js                          [新增] 字幕状态模型
```

### 13.2 重构文件

| 文件 | 当前行数 | 目标行数 | 重构方式 |
|------|---------|---------|---------|
| `transcription_service.py` | 4,931 | < 1,500 | 拆分为JobManager、CheckpointManager、EventEmitter、Pipeline |
| `sensevoice_onnx_service.py` | 875 | < 800 | 提取执行器接口，保持核心推理逻辑 |
| `whisper_service.py` | 606 | < 600 | 提取执行器接口，保持核心推理逻辑 |
| `streaming_subtitle.py` | 258 | < 300 | 增强SSE功能，保持字幕流逻辑 |

### 13.3 保留文件（无需修改）

```
backend/app/services/
├── model_manager_service.py             [保留] 模型下载管理
├── model_preload_manager.py             [保留] 模型预加载
├── hardware_service.py                  [保留] 硬件检测
├── sse_service.py                       [保留] SSE核心
└── job_queue_service.py                 [保留] 任务队列
```

### 13.4 删除文件

无需删除文件，所有旧代码保留作为参考。

---

## 14. 分阶段实施计划

### Phase 1: 基础架构搭建（第1-2周）

**目标**: 建立新的目录结构和核心模块

#### 任务清单
1. **创建目录结构**
   - 创建 `pipelines/`、`services/job/`、`services/inference/` 等目录
   - 创建所有 `__init__.py` 文件

2. **实现核心数据模型**
   - `confidence_models.py`: WordTimestamp, AlignedSubtitle
   - `preset_models.py`: PresetConfig
   - 修改 `job_models.py`: 新增字段

3. **实现资源管理器**
   - `resource_manager.py`: 显存生命周期管理
   - `hardware_monitor.py`: 实时硬件监测

4. **增强日志系统**
   - 重构 `logging.py`: 日志轮转、结构化输出
   - 测试日志上下文管理器

#### 验证标准
- [ ] 所有新目录和文件创建完成
- [ ] 数据模型单元测试通过
- [ ] ResourceManager 可以正确管理模型加载/卸载
- [ ] 日志系统正常工作，支持轮转

#### 测试脚本
```python
# backend/scripts/test_phase1.py

async def test_resource_manager():
    """测试资源管理器"""
    from app.core.resource_manager import ResourceManager
    from app.services.monitoring.hardware_monitor import HardwareMonitor

    monitor = HardwareMonitor()
    rm = ResourceManager(monitor)

    # 测试显存查询
    vram = rm.get_available_vram()
    print(f"可用显存: {vram} MB")

    # 测试模型加载
    whisper = await rm.acquire_whisper("medium")
    assert whisper is not None

    # 测试模型卸载
    await rm.unload("whisper")
    print("Phase 1 测试通过")

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_resource_manager())
```

---

### Phase 2: 音频前处理流水线（第3-4周）

**目标**: 实现音频提取、人声分离、VAD切分

#### 任务清单
1. **实现ChunkEngine**
   - `chunk_engine.py`: 音频切分引擎
   - 集成Demucs和VAD

2. **实现AudioProcessingPipeline**
   - `audio_processing_pipeline.py`: 完整前处理流程
   - 显存自适应策略

3. **重构Demucs服务**
   - 支持整轨分离
   - 支持大块切分（5分钟）

4. **封装VAD服务**
   - `vad_service.py`: Silero VAD封装

#### 验证标准
- [ ] 可以正确提取音频并降采样到16kHz
- [ ] Demucs整轨分离正常工作
- [ ] VAD切分准确，返回标准AudioChunk列表
- [ ] 显存自适应策略生效

#### 测试脚本

```python
# backend/scripts/test_phase2.py

async def test_audio_pipeline():
    """测试音频前处理流水线"""
    from app.pipelines.audio_processing_pipeline import AudioProcessingPipeline
    from app.services.audio.chunk_engine import ChunkEngine
    from app.services.demucs_service import DemucsService
    from app.core.resource_manager import ResourceManager

    # 初始化
    chunk_engine = ChunkEngine()
    demucs_service = DemucsService()
    resource_manager = ResourceManager(hardware_monitor)

    pipeline = AudioProcessingPipeline(
        chunk_engine=chunk_engine,
        demucs_service=demucs_service,
        resource_manager=resource_manager
    )

    # 测试
    test_video = "test_data/sample.mp4"
    chunks = await pipeline.process(test_video, enable_demucs=True)

    print(f"切分完成，共 {len(chunks)} 个片段")
    for i, chunk in enumerate(chunks[:3]):
        print(f"Chunk {i}: {chunk.start:.2f}s - {chunk.end:.2f}s")

    assert len(chunks) > 0
    print("Phase 2 测试通过")

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_audio_pipeline())
```

---

### Phase 3: 对齐算法实现（第5-6周）

**目标**: 实现锚点对齐算法

#### 任务清单

1. **实现AlignmentService**
   - `alignment_service.py`: 核心对齐算法
   - **Needleman-Wunsch 序列对齐**（替代 difflib）
   - **静音区硬约束**: VAD 静音段视为禁区
   - **能量锚点校准**: 利用音频能量峰值重新定位边界
   - VAD边界校准（最终保护）
   - Gap填补

2. **实现KeywordExtractor**
   - `keyword_extractor.py`: 关键词提取服务
   - 从 SenseVoice 草稿中提取人名、生僻词（NER）
   - 不要把整句草稿放进 Whisper Prompt

3. **实现推理执行器**
   - `sensevoice_executor.py`: SenseVoice执行器
   - `whisper_executor.py`: Whisper执行器

3. **单元测试**
   - 测试完美匹配场景
   - 测试替换场景（Whisper纠错）
   - 测试插入场景（SenseVoice漏字）
   - 测试删除场景（SenseVoice幻觉）

#### 验证标准
- [ ] 对齐算法通过所有单元测试
- [ ] 对齐率 > 80%
- [ ] VAD边界校准正常工作
- [ ] 置信度正确保留

#### 测试脚本
```python
# backend/scripts/test_phase3.py

async def test_alignment():
    """测试对齐算法"""
    from app.services.alignment.alignment_service import AlignmentService
    from app.models.confidence_models import WordTimestamp

    aligner = AlignmentService()

    # 测试数据
    whisper_text = "Hello world this is AI"
    sv_tokens = [
        WordTimestamp("hello", 0.0, 0.3, 0.9),
        WordTimestamp("world", 0.3, 0.6, 0.85),
        WordTimestamp("this", 0.6, 0.8, 0.92),
        WordTimestamp("is", 0.8, 0.9, 0.88),
        WordTimestamp("ai", 0.9, 1.1, 0.95)
    ]
    vad_range = (0.0, 1.2)

    # 执行对齐
    result = await aligner.align(
        whisper_text=whisper_text,
        sv_tokens=sv_tokens,
        vad_range=vad_range,
        chunk_offset=0.0
    )

    print(f"对齐结果: {result.text}")
    print(f"字数: {len(result.words)}")
    print(f"对齐质量: {result.alignment_score:.2f}")

    assert len(result.words) == 5
    assert result.alignment_score > 0.8
    print("Phase 3 测试通过")

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_alignment())
```

---

### Phase 4: 双流流水线组装（第7-8周）

**目标**: 组装完整的双流对齐流水线

#### 任务清单

1. **实现DualAlignmentPipeline**
   - `dual_alignment_pipeline.py`: 核心流水线
   - 快流（SenseVoice）+ 关键词提取
   - **智能 Prompt 构建**: 上一句Whisper + Glossary (用户词表 + SenseVoice关键词)
   - 慢流（Whisper）
   - 对齐（传入静音区间和能量锚点）
   - Prompt 缓存管理

2. **实现增强版SSE Publisher**
   - `sse_publisher.py`: 历史事件、优先级
   - 新增历史事件API

3. **实现JobManager和CheckpointManager**
   - 从transcription_service拆分
   - 保持API兼容

4. **CLI测试**
   - 完整流程CLI测试
   - 不依赖前端

#### 验证标准
- [ ] 双流流水线正常工作
- [ ] 草稿秒级上屏
- [ ] 定稿正确覆盖
- [ ] SSE事件正常推送
- [ ] 断点续传正常工作

#### 测试脚本
```python
# backend/scripts/test_phase4.py

async def test_dual_pipeline():
    """测试双流流水线"""
    from app.pipelines.dual_alignment_pipeline import DualAlignmentPipeline
    from app.pipelines.audio_processing_pipeline import AudioProcessingPipeline

    # 初始化所有组件
    audio_pipeline = AudioProcessingPipeline(...)
    dual_pipeline = DualAlignmentPipeline(...)

    # 测试视频
    test_video = "test_data/sample.mp4"

    # 1. 音频前处理
    chunks = await audio_pipeline.process(test_video)
    print(f"音频切分完成: {len(chunks)} 个片段")

    # 2. 双流推理
    job_id = "test_job_001"
    config = JobConfig(language="zh", enable_llm=False)

    await dual_pipeline.run(
        job_id=job_id,
        chunks=chunks,
        config=config
    )

    print("Phase 4 测试通过")

if __name__ == "__main__":
    import asyncio
    asyncio.run(test_dual_pipeline())
```

---

### Phase 5: 前端适配（第9-10周）

**目标**: 前端支持双流显示和置信度可视化

#### 任务清单
1. **修改SSEChannelManager**
   - 增强断线重连
   - 历史事件拉取

2. **实现SubtitleItem组件**
   - 置信度可视化
   - 草稿/定稿样式切换

3. **实现SSEStatusIndicator**
   - SSE连接状态指示

4. **字幕更新节流**
   - 批量更新机制

5. **修改PresetSelector**
   - 硬件提示
   - 预设推荐

#### 验证标准
- [ ] 草稿显示为灰色斜体
- [ ] 定稿自动覆盖为黑色正体
- [ ] 低置信度字幕高亮显示
- [ ] SSE断线重连正常
- [ ] 预设推荐准确

#### 测试清单
- [ ] 创建任务，选择Standard预设
- [ ] 观察草稿秒级上屏
- [ ] 观察定稿自动覆盖
- [ ] 检查低置信度高亮
- [ ] 断开网络，重连后字幕完整

---

### Phase 6: 预设系统和监控（第11-12周）

**目标**: 实现预设系统和硬件监控

#### 任务清单

1. **实现PresetRecommender**
   - 硬件自适应推荐

2. **实现监控API**
   - `/api/monitor/system/status`
   - `/api/monitor/system/start`
   - `/api/monitor/system/stop`

3. **实现ModelPerformanceMonitor**
   - 模型性能指标收集

4. **前端监控面板**
   - 实时显示GPU/CPU状态
   - 模型性能统计

#### 验证标准
- [ ] 预设推荐准确
- [ ] 监控API正常工作
- [ ] 前端实时显示硬件状态
- [ ] 模型性能指标正确

---

### Phase 7: LLM集成（第13-14周）

**目标**: 集成LLM校对和翻译功能

#### 任务清单
1. **实现LLM服务**
   - `llm_service.py`: 统一接口
   - OpenAI Provider
   - Claude Provider

2. **集成到流水线**
   - 可选的LLM校对
   - 可选的LLM翻译

3. **前端LLM设置**
   - LLMSettings组件
   - API Key配置

4. **测试LLM功能**
   - 校对测试
   - 翻译测试

#### 验证标准
- [ ] LLM校对正常工作
- [ ] LLM翻译正常工作
- [ ] 上下文正确传递
- [ ] 时间戳正确保留

---

### Phase 8: 回归测试和优化（第15-16周）

**目标**: 全面测试和性能优化

#### 任务清单
1. **回归测试**
   - 测试所有预设
   - 测试所有语言
   - 测试边界情况

2. **性能优化**
   - 显存使用优化
   - SSE推送优化
   - 前端渲染优化

3. **文档更新**
   - 更新llmdoc
   - 更新API文档
   - 更新用户手册

4. **Bug修复**
   - 修复测试中发现的问题

#### 验证标准
- [ ] 所有测试用例通过
- [ ] 性能达到预期
- [ ] 文档完整准确
- [ ] 无已知严重Bug

#### 性能基准
| 指标 | v2.x | v3.0目标 |
|------|------|---------|
| 草稿上屏时间 | N/A | < 1秒 |
| 定稿覆盖时间 | N/A | < 5秒 |
| 对齐准确率 | N/A | > 85% |
| 显存峰值 | 不可控 | < 8GB |
| transcription_service.py行数 | 4,931 | < 1,500 |

---

## 15. 风险评估与缓解

### 15.1 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 对齐算法准确率不达标 | 高 | 中 | 充分的单元测试，多种场景覆盖 |
| 显存管理失效导致OOM | 高 | 中 | 实时监测，自动降级策略 |
| SSE断线重连失败 | 中 | 低 | 完善的错误处理，降级到轮询 |
| LLM API调用失败 | 中 | 中 | 失败时返回原字幕，不影响主流程 |
| 前端性能问题 | 中 | 低 | 节流机制，虚拟滚动 |

### 15.2 项目风险

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|---------|
| 开发周期超期 | 中 | 中 | 分阶段实施，每阶段可独立验证 |
| 向后兼容性问题 | 低 | 低 | 项目未发布，无需考虑向后兼容 |
| 测试覆盖不足 | 中 | 中 | 每个Phase都有明确的测试标准 |

---

## 16. 总结

### 16.1 重构收益

1. **代码质量提升**
   - transcription_service.py从4,931行降至<1,500行
   - 单一职责原则，每个模块职责明确
   - 可测试性大幅提升

2. **架构优化**
   - 时空解耦，Whisper负责文本，SenseVoice负责时间
   - 快慢双流，用户体验提升
   - 显存生命周期管理，OOM风险降低

3. **功能增强**
   - 实时硬件监测和预警
   - 智能预设推荐
   - LLM校对和翻译支持
   - 完整的置信度保留

4. **可维护性提升**
   - 模块化设计，易于扩展
   - 统一的日志管理
   - 完善的文档

### 16.2 实施建议

1. **严格按阶段推进**
   - 每个Phase完成后进行验证
   - 不要跳过测试环节

2. **保持代码质量**
   - 每个新文件控制在1000行以内
   - 充分的单元测试
   - 代码审查

3. **及时更新文档**
   - 每个Phase完成后更新llmdoc
   - 保持文档与代码同步

4. **性能监控**
   - 每个Phase都要进行性能测试
   - 及时发现和解决性能问题

---

**文档完成日期**: 2025-12-08
**预计实施周期**: 16周
**预计完成日期**: 2026-04-08
