# Video-to-SRT v3.0 重构开发文档

**项目名称**: Video-to-SRT (GPU Edition) Refactoring
**版本**: 3.0.0
**核心架构**: 双模态时空解耦流水线 (Dual-Model Spatiotemporal Decoupled Pipeline)
**关键特性**: 快慢双流、整轨分离、锚点对齐、资源自适应
**文档日期**: 2025-12-08

---

## 目录

1. [项目现状与重构目标](#1-项目现状与重构目标)
2. [设计理念](#2-设计理念)
3. [架构总览](#3-架构总览)
4. [核心模块详细设计](#4-核心模块详细设计)
5. [预设系统重构](#5-预设系统重构)
6. [统一日志管理](#6-统一日志管理)
7. [统一模型管理](#7-统一模型管理)
8. [SSE系统调整](#8-sse系统调整)
9. [前端进度系统调整](#9-前端进度系统调整)
10. [GPU/CPU实时监测系统](#10-gpucpu实时监测系统)
11. [置信度保留设计](#11-置信度保留设计)
12. [LLM校对与翻译接口设计](#12-llm校对与翻译接口设计)
13. [文件变更清单](#13-文件变更清单)
14. [分阶段实施计划](#14-分阶段实施计划)

---

## 1. 项目现状与重构目标

### 1.1 当前痛点 (v2.x)

#### 架构缺陷
- **职责混乱**: `transcription_service.py` 长达 **4,931 行**，单一类承担 8 种不同职责（任务管理、断点续传、SSE推送、音频处理、模型推理、结果输出、质量控制、熔断处理）
- **模式错位**: 试图用 SenseVoice 硬扛高精度任务，Whisper 仅作为"补丁"触发，导致漏字和幻觉无法根本解决
- **效率瓶颈**: VAD 切片后单独进行 Demucs 人声分离，导致 GPU 显存频繁交换，且上下文丢失影响分离质量

#### 代码臃肿分析

| 文件 | 行数 | 问题 |
|------|------|------|
| `transcription_service.py` | 4,931 | 极度臃肿，需立即解耦 |
| `sensevoice_onnx_service.py` | 875 | 较大但职责清晰 |
| `whisper_service.py` | 606 | 合理 |
| `streaming_subtitle.py` | 258 | 合理 |

#### 超长方法统计
- `_run_pipeline`: 560 行
- `_safe_load_audio`: 361 行
- `_split_audio`: 342 行

#### 功能缺失
- 缺乏实时 GPU 显存监测和 OOM 保护
- 缺乏统一的日志轮转和结构化输出
- 预设系统与硬件能力脱节
- SSE 断线重连后无历史事件补发

### 1.2 v3.0 重构目标

1. **时空解耦**: Whisper (Large-v3) 负责**文本/语义**，SenseVoice 负责**时间/边界**
2. **快慢双流**: 极速草稿 (Draft) 秒级上屏，精准定稿 (Final) 延迟覆盖
3. **代码解耦**: 将 `transcription_service.py` 拆分为多个独立服务，每个文件控制在 1000 行以内
4. **工程鲁棒**: 明确的显存生命周期管理，支持断点续连和错误回退
5. **智能预设**: 基于硬件能力的预设推荐和动态调整

---

## 2. 设计理念

### 2.1 时空解耦原则

将字幕生成的两个核心要素彻底分离：

```
┌─────────────────────────────────────────────────────────────┐
│                    时空解耦架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────────────┐         ┌─────────────────┐          │
│   │   Whisper       │         │   SenseVoice    │          │
│   │   (语义之王)     │         │   (时间之王)     │          │
│   ├─────────────────┤         ├─────────────────┤          │
│   │ - 听清内容       │         │ - CTC 精准边界   │          │
│   │ - 加标点符号     │         │ - 字级时间戳     │          │
│   │ - 语义分段       │         │ - 快速推理       │          │
│   │ - 纠正错别字     │         │ - 置信度输出     │          │
│   └────────┬────────┘         └────────┬────────┘          │
│            │                           │                    │
│            │      ┌─────────────┐      │                    │
│            └─────►│ Alignment   │◄─────┘                    │
│                   │ Service     │                           │
│                   │ (锚点对齐)   │                           │
│                   └──────┬──────┘                           │
│                          │                                  │
│                          ▼                                  │
│                   ┌─────────────┐                           │
│                   │ Final       │                           │
│                   │ Subtitle    │                           │
│                   │ (完美字幕)   │                           │
│                   └─────────────┘                           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 快慢双流体验

用户不再等待完整的 Whisper 推理：

```
时间轴 ─────────────────────────────────────────────────────►

Chunk 1:
  [SenseVoice CPU] ━━━━━ (0.3s) ━━━━━► Draft 上屏 (灰色斜体)
  [Whisper GPU]    ━━━━━━━━━━━━━━━━━━━━━━━ (3s) ━━━━━► Final 覆盖 (黑色正体)

Chunk 2:
  [SenseVoice CPU] ━━━━━ (0.3s) ━━━━━► Draft 上屏
  [Whisper GPU]    ━━━━━━━━━━━━━━━━━━━━━━━ (3s) ━━━━━► Final 覆盖

用户体验: 秒级看到草稿，几秒后自动精修
```

### 2.3 单一职责原则

每个模块只做一件事：

| 模块 | 职责 | 行数目标 |
|------|------|----------|
| `JobManager` | 任务 CRUD 和生命周期 | < 500 |
| `CheckpointManager` | 断点续传 | < 300 |
| `TranscriptionEventEmitter` | SSE 事件发送 | < 400 |
| `AudioProcessingPipeline` | 音频前处理 | < 800 |
| `DualAlignmentPipeline` | 双流推理和对齐 | < 1000 |
| `ResourceManager` | 显存/模型生命周期 | < 500 |

---

## 3. 架构总览

### 3.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Video-to-SRT v3.0 架构                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                     │
│  │   Frontend  │    │   API       │    │   SSE       │                     │
│  │   (Vue 3)   │◄──►│   Gateway   │◄──►│   Manager   │                     │
│  └─────────────┘    └──────┬──────┘    └──────┬──────┘                     │
│                            │                  │                             │
│  ════════════════════════════════════════════════════════════════════════  │
│                            │                  │                             │
│                     ┌──────▼──────┐    ┌──────▼──────┐                     │
│                     │ JobManager  │    │ EventEmitter│                     │
│                     │ (任务管理)   │    │ (事件发送)   │                     │
│                     └──────┬──────┘    └─────────────┘                     │
│                            │                  ▲                             │
│  ════════════════════════════════════════════════════════════════════════  │
│                            │                  │                             │
│  ┌─────────────────────────▼──────────────────┴─────────────────────────┐  │
│  │                    DualAlignmentPipeline (核心流水线)                  │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │  │ Phase 1: Global Pre-processing                                  │ │  │
│  │  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐    │ │  │
│  │  │  │ Audio    │──►│ Demucs   │──►│ Clean    │──►│ VAD      │    │ │  │
│  │  │  │ Extract  │   │ (整轨)    │   │ Audio    │   │ Split    │    │ │  │
│  │  │  └──────────┘   └──────────┘   └──────────┘   └────┬─────┘    │ │  │
│  │  └────────────────────────────────────────────────────┼──────────┘ │  │
│  │                                                       │            │  │
│  │  ┌────────────────────────────────────────────────────▼──────────┐ │  │
│  │  │ Phase 2: Dual-Stream Inference                                │ │  │
│  │  │                                                               │ │  │
│  │  │  ┌──────────────┐                    ┌──────────────┐        │ │  │
│  │  │  │ SenseVoice   │──► Draft ──────────► SSE: draft   │        │ │  │
│  │  │  │ (CPU/Int8)   │    (0.3s)          │              │        │ │  │
│  │  │  └──────┬───────┘                    └──────────────┘        │ │  │
│  │  │         │ Time Tokens                                        │ │  │
│  │  │         ▼                                                    │ │  │
│  │  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐   │ │  │
│  │  │  │ Whisper      │───►│ Alignment    │───►│ SSE:         │   │ │  │
│  │  │  │ (GPU)        │    │ Service      │    │ overwrite    │   │ │  │
│  │  │  └──────────────┘    └──────────────┘    └──────────────┘   │ │  │
│  │  │         (3s)              (0.1s)                             │ │  │
│  │  └──────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│  ════════════════════════════════════════════════════════════════════════ │
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │ Resource     │  │ Model        │  │ Logger       │  │ Hardware     │ │
│  │ Manager      │  │ Manager      │  │ Manager      │  │ Monitor      │ │
│  │ (显存管理)    │  │ (模型下载)    │  │ (统一日志)    │  │ (资源监测)    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.2 核心流水线流程图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        转录流水线详细流程                                 │
└─────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────┐
                              │ 用户上传视频 │
                              └──────┬──────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 1. 音频提取 & 降采样   │
                         │    (16kHz mono)       │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 2. 显存策略检查        │
                         └───────────┬───────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
              ▼                      ▼                      ▼
     ┌────────────────┐    ┌────────────────┐    ┌────────────────┐
     │ VRAM > 6GB     │    │ VRAM < 6GB     │    │ No GPU         │
     │ Demucs 整轨    │    │ Demucs 5min块  │    │ Demucs CPU/跳过│
     └────────┬───────┘    └────────┬───────┘    └────────┬───────┘
              │                      │                      │
              └──────────────────────┼──────────────────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 3. 纯人声轨道          │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 4. Silero VAD 切分    │
                         │    (基于纯人声)        │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │ 5. 有序 Chunk 队列     │
                         └───────────┬───────────┘
                                     │
              ┌──────────────────────┴──────────────────────┐
              │                                             │
              ▼                                             ▼
     ┌────────────────────┐                    ┌────────────────────┐
     │ 6a. SenseVoice     │                    │ 6b. Whisper        │
     │     (CPU/Int8)     │                    │     (GPU)          │
     │     极速推理        │                    │     深度推理        │
     └─────────┬──────────┘                    └─────────┬──────────┘
               │                                         │
               │ Draft Result                            │ Raw Text
               │ (text + time_tokens)                    │
               │                                         │
               ▼                                         │
     ┌────────────────────┐                              │
     │ 7. SSE: draft      │                              │
     │    (灰色斜体上屏)   │                              │
     └────────────────────┘                              │
                                                         │
               ┌─────────────────────────────────────────┘
               │
               ▼
     ┌────────────────────┐
     │ 8. Alignment       │
     │    Service         │
     │    (锚点对齐)       │
     │                    │
     │  - difflib 匹配    │
     │  - VAD 边界校准    │
     │  - Gap 线性插值    │
     └─────────┬──────────┘
               │
               ▼
     ┌────────────────────┐
     │ 9. SSE: overwrite  │
     │    (黑色正体覆盖)   │
     └─────────┬──────────┘
               │
               ▼
     ┌────────────────────┐
     │ 10. 可选: LLM 校对  │
     │     (语义润色)      │
     └─────────┬──────────┘
               │
               ▼
     ┌────────────────────┐
     │ 11. 生成 SRT 文件   │
     └────────────────────┘
```

### 3.3 目录结构重构

```
backend/app/
├── core/
│   ├── config.py                    # 全局配置
│   ├── logging.py                   # [重构] 统一日志管理
│   ├── thresholds.py                # 阈值配置
│   └── resource_manager.py          # [新增] 显存/模型生命周期管理
│
├── pipelines/
│   ├── __init__.py
│   ├── base_pipeline.py             # [新增] 流水线基类
│   ├── dual_alignment_pipeline.py   # [新增] 双流对齐流水线
│   └── audio_processing_pipeline.py # [新增] 音频前处理流水线
│
├── services/
│   ├── job/
│   │   ├── __init__.py
│   │   ├── job_manager.py           # [新增] 任务管理器
│   │   ├── checkpoint_manager.py    # [新增] 断点续传管理
│   │   └── job_state.py             # [新增] 任务状态定义
│   │
│   ├── inference/
│   │   ├── __init__.py
│   │   ├── sensevoice_executor.py   # [重构] SenseVoice 执行器
│   │   └── whisper_executor.py      # [重构] Whisper 执行器
│   │
│   ├── alignment/
│   │   ├── __init__.py
│   │   ├── alignment_service.py     # [新增] 对齐算法服务
│   │   └── pseudo_alignment.py      # [保留] 伪对齐算法
│   │
│   ├── audio/
│   │   ├── __init__.py
│   │   ├── chunk_engine.py          # [新增] 音频切分引擎
│   │   ├── demucs_service.py        # [保留] 人声分离
│   │   └── vad_service.py           # [新增] VAD 服务封装
│   │
│   ├── streaming/
│   │   ├── __init__.py
│   │   ├── sse_publisher.py         # [重构] 增强版 SSE 发布器
│   │   └── streaming_subtitle.py    # [保留] 字幕流
│   │
│   ├── monitoring/
│   │   ├── __init__.py
│   │   ├── hardware_monitor.py      # [新增] 实时硬件监测
│   │   └── resource_tracker.py      # [新增] 资源使用追踪
│   │
│   ├── llm/
│   │   ├── __init__.py
│   │   ├── llm_service.py           # [新增] LLM 服务接口
│   │   ├── proofreader.py           # [新增] 校对服务
│   │   └── translator.py            # [新增] 翻译服务
│   │
│   ├── model_manager_service.py     # [保留] 模型下载管理
│   ├── model_preload_manager.py     # [保留] 模型预加载
│   ├── hardware_service.py          # [保留] 硬件检测
│   ├── sse_service.py               # [保留] SSE 核心
│   └── transcription_service.py     # [重构] 精简为协调器
│
├── models/
│   ├── job_models.py                # [重构] 任务模型
│   ├── preset_models.py             # [新增] 预设模型
│   ├── confidence_models.py         # [新增] 置信度模型
│   └── ...
│
└── api/
    └── routes/
        ├── transcription_routes.py  # [保留]
        ├── preset_routes.py         # [新增] 预设 API
        └── monitor_routes.py        # [新增] 监控 API
```

---


