旧架构里确实是“按需 + 按 Chunk”分离：在 TranscriptionService 的主流程中（backend/app/services/transcription_service.py (lines 5315-5466)）会先对 VAD 产出的每个 chunk 做频谱诊断 diagnose_chunks(...)，诊断结果里包含 need_separation 和推荐模型。随后只对 need_separation=True 的 chunk 调 demucs_service.separate_chunk(...)，并在全部 chunk 判定为纯净人声时立刻 demucs_service.unload_model() 释放显存（backend/app/services/transcription_service.py (lines 5438-5450)）。这就是旧流水线的“频谱分诊→逐段分离”的实现。

新架构目前在 job_queue_service 里走的是另一条路：直接在音频前处理阶段调用 DemucsService 做 full_track 分离（logs/backend/1217.log (lines 111-149)），完全绕开了 audio_spectrum_classifier 那套机制，所以你看到的是整轨 Demucs，显存长期维持在 8 GB。若希望新架构保持与旧架构相同的策略，就需要把 audio_spectrum_classifier 那套逻辑移植/挂接到新的并行流水线上：

1. 先对 VAD chunk 做 spectrum_classifier.diagnose_chunks(...)（同 backend/app/services/audio_spectrum_classifier.py），得到每段的 need_separation。
2. 只有当诊断认为 “heavy/light” 并确实有噪声时才调用 demucs_service.separate_chunk()，其余 chunk 直接沿用原始音频。
3. 当诊断发现全部 chunk 都无需分离时，及时 demucs_service.unload_model()，避免 Demucs 长驻显存。

这样新架构就会回到“频谱诊断逐段分析，只对有噪声的 chunk 分离”的设计，同时保留并行双流的优势。







- **阶段 1（当前 sprint 即刻执行）**：围绕已知“细节瑕疵”做低成本修正，确保 6 级素材的字幕质量扎实。包括：
  - 在 TextNormalizer / Alignment 后处理里加入数字格式修正、全角标点→半角替换、标点后补空格、<0.5s 微段自动并入后一块、N-gram 去重规则。
  - 暴露 Whisper repetition_penalty / no_repeat_ngram_size 到配置，方便针对高难素材调参。
  - 落地 “SenseVoice 兜底 + 轻量 Punctuator” 流程，保证回退文本可读。
  - 评估一次更复杂音频（稍高难度材料），验证这些 Quick Win 是否稳定提升。
- **阶段 2（下一迭代）**：在细节已稳定的基础上，做结构性优化但不改大框架：
  - 完成 Demucs “频谱分诊按需分离”迁移，解决显存和前处理时间。
  - 调整异步流水线的 queue_maxsize / Alignment 并行，让 GPU 在当前 6 级素材上不空转；继续用中等难度音频验证吞吐。
  - 针对 Whisper 的缓冲池逻辑做温和改造：限定最大等待时长、捆绑 overlap 配置，减少极短切片的产生。
- **阶段 3（中期专项）**：在前两阶段效果稳定、并收集到高难素材表现后，再投入“语义驱动动态缓冲”计划：
  - 设计 SemanticBuffer 数据结构和调度算法，复用 SenseVoice 字级时间戳做句边判断。
  - 让 SlowWorker 支持“前段拼接 + trimming”逻辑，并在 Alignment 中实现 Whisper 输出到原时间轴的映射。
  - 分阶段上线（可先灰度到部分任务），重点观察更高难度、跨语言素材的准确率与延迟。






onset,0.4,更灵敏。宁可多切一点噪音，也不要漏掉开头的弱音（呼吸声、唇音）。
offset,0.4，用于检测句尾。
min_speech_duration_ms,250,关键回调。从 500 降回 250。允许短促的语气词触发检测，避免“吃字头”。
min_silence_duration_ms,500 ~ 800,保持现状或略大。避免把句中停顿切碎。
speech_pad_ms,300,新增/关键。检测到语音后，往前多取 300ms，往后多取 300ms。这是解决“时间戳偏后”的神器。